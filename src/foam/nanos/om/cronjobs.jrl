p({"class":"foam.nanos.cron.Cron","id":"OMInfoRollup","enabled":true, "code":"import foam.dao.DAO;\nimport foam.nanos.logger.Logger;\nimport foam.nanos.om.OMInfo;\nimport foam.nanos.om.DAOOMLoggerCopySink;\nimport foam.nanos.pm.PM;\nimport foam.nanos.script.Script;\n\nscriptName = \"OMInfoRollup\";\n\nlogger = x.get(\"logger\");\npm = new PM(Script.class, \"scriptName\");\nlogger.info(new String[] {scriptName, \"start\"});\n\n// current 1 minute dao\ndao = x.get(\"omInfoDAO\").getDelegate();\n\n// replace with new empty dao\nx.get(\"omInfoDAO\").setDelegate(new foam.dao.MDAO(foam.nanos.om.OMInfo.getOwnClassInfo()));\n\none = x.get(\"omInfo1minDAO\");\nfive = x.get(\"omInfo5minDAO\");\nhour = x.get(\"omInfo1hourDAO\");\nday = x.get(\"omInfo1dayDAO\");\n\n//logger.info(new String[] {scriptName, \"daos\", one.toString(), five.toString(), hour.toString(), day.toString()});\n//logger.info(new String[] {scriptName, \"current replaced\"});\n\n// move previous 1 minute to named 1 minute dao\none.setDelegate(dao);\n\n// cleanup\nnow = java.time.LocalDateTime.now();\n\n// if at 5 minute interval of hour clear 5 minute dao\nif ( now.getMinute() % 5 == 0 ) {\n  five.removeAll();\n  logger.info(new String[] {scriptName,\"clean 5 minute\"});\n}  \n\n// if at top of the hour, clear hour dao, if start of day.\nif ( now.getMinute() == 0 ) {\n  hour.removeAll();\n  logger.info(new String[] {scriptName,\"clean 1 hour\"});\n  if ( now.getHour() == 0 ) {\n    day.removeAll();\n    logger.info(new String[] {scriptName,\"clean 1 day\"});\n  }\n}\n\n// put 1 minute entries into other daos.\nDAO[] daos = new DAO[] { five, hour, day };\ndao.select(new DAOOMLoggerCopySink(x, daos));\nlogger.info(new String[] {scriptName,\"end\"});\npm.log(x);\n\n"})
